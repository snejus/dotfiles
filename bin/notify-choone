#!/usr/bin/bash

musicdir=/media/music
coversdir=$musicdir/covers

get_coverpic() {
    filepath=$1
    file="$(basename "$filepath")"
    albumdir="$(dirname "$filepath")"

    coverpic=""
    # check if it's found in the album dir
    coverpic="$(fd -e png -e jpg -d1 -1 ^cover "$albumdir")"

    # if not, check our covers dir, use filename
    if [[ -z $coverpic ]]; then
        coverpic="$(fd -e png -e jpg "$file" $coversdir)" 
    fi

    # if not, extract the cover if it's a flac file
    if [[ -z $coverpic ]] && [[ $file =~ "flac" ]]; then
        single="${file/[01][0-9][ ]*}"
        if [[ -z $single ]]; then  # part of an album, use that folder
            coverpic=$albumdir/cover.png
         else # move to the generic covers dir
            coverpic=$coversdir/$coverpic
        fi
        metaflac "$filepath" --export-picture-to "$coverpic" 2> /dev/null || coverpic=""
    fi
    echo "$coverpic"
}

notify() {
    message="$(sed 1d <<< "$1")"
    filepath=$musicdir/$(head -1 <<< "$1")
    coverpic="$(get_coverpic "$filepath")"
    if [[ -n "$coverpic" ]]; then
        notify-send "ðŸ”Š" "\n$message" -i "$coverpic"
    else
        notify-send "ðŸ”Š" "\n$message"
    fi
}

format='%file%\n%title% \n%artist% \n%album%'
notify "$(mpc --format "$format" current)"

if [[ ! $1 == now ]]; then
    while true; do
        notify "$(nice -n 19 mpc --format "$format" current --wait)" || exit 1
    done
fi

