##### GENERAL #####

RED='1;31'
GREEN='1;32'
YELLOW='1;33'
BLUE='1;34'
MAGENTA='1;35'
AQUA='1;36'
WHITE='1;37'
# BLUE='1;38' same blue
GREY='1;39'

clrred() { printf '\e[%sm%s\e[0m' $RED $1 }
clrgreen() { printf '\e[%sm%s\e[0m' $GREEN $1 }
clryellow() { printf '\e[%sm%s\e[0m' $YELLOW $1 }

xprint() { xargs -I{} echo -e {} }
shrinkmp4() { ffmpeg -i $1 -vcodec libx265 -crf 2 $2 }

dadjoke() {
   echo "\
$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1
$1$2$1$2$1$1$2$1$1$2$1$2$1$1$2$1$1
$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1
$1$2$2$2$1$2$2$2$1$2$2$2$1$2$2$2$1
$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1
$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1$2$1
$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1$1"
}


##### PYTHON #####
cache_purge() {
    remove_file_folder f .coverage $1
    remove_file_folder d __pycache__ $1
    remove_file_folder d .pytest_cache $1
    remove_file_folder d .eggs $1
    remove_file_folder d build $1
    remove_file_folder d dist $1
    remove_file_folder d *.egg-info $1
    echo Finished removing caches
}

remove_file_folder() {
    count=0
    for file in $(find . -name $2 -type $1);
    do
        rm -rf $file $3
    let "count++"
    done
    if [ $count -gt 0 ]; then
        echo "- Removed $count $2"
    fi
}

depopen() {
    echo Opening $1 repository in the browser
    xdg-open `pip show $1 | sed -n 's/^.*\(.*github\)/\1/p'`
}

deps() {
    echo Generating pydeps dependencies graph for $1
    pydeps $1 --max-bacon 2 --include-missing --reverse -T png
}

restshow() { restview --css ~/.ref/github.css $1 }
runmypy() { mypy $1 --html-report reports --show-traceback --pretty }

search_skipped() {
    ag --nogroup --color --color-path $AQUA $1 tests src | \
        tee /dev/null | \
        sed 's/:.*//' | \
        tee >(wc -l) >(printf '\n\e[%smTOTAL: ' "$YELLOW") | \
        sort | uniq -c | sort -r
}

skipped_flake() { search_skipped 'noqa|flake8' }
skipped_pylint() { search_skipped 'pylint: ?d' }
skipped_mypy() { search_skipped 'type: ignore' }

skipped_pylint_by_error() {
    ag --nogroup --color --color-path '1;36' 'pylint: ?dis' tests src |
    tee /dev/null |
    sed 's/.*able\ \?=\ \?//' | tr , '\n' | tr -d ' ' |
    tee >(wc -l) >(printf '\e[%smTOTAL: \e[%sm' $MAGENTA $GREY) |
    sort | uniq -c | sort -rh
}

check() {
   [ -z $2 ] && echo "$(clrred ERROR: ) $1" && return 1
   return 0
}

changelog() {
   local package=$1

   check "Please 'export GITHUB_TOKEN=<your-github-token>'" $GITHUB_TOKEN || return 1
   check "Please provide a package name: changelog <package-name>" $package || return 1

   echo "Looking for a package $(clrgreen $1) changelog"

   pip show $package &> /dev/null
   if [ ! $? -eq 0 ]; then
      echo "$(clrred ERROR: ) Pip didn't find the package" && return 1
   fi

   # sed patterns
   local pat_homepage='s/Home-page: //p'
   local pat_projectname='s/^.*hub\.com\/\(.*\/\?\$\?\)/\1/pI'
   local pat_changelogurl='s/download_url.*\(https.*change.*\),/\1/pI'
   local pat_downloadurl='s/download_url.*\(https.*\),/\1/pI'

   local homepage=$(pip show $package | sed -n $pat_homepage)
   echo "$(clrgreen Home-page:) $homepage"

   local projectname=$(echo $homepage | sed -n $pat_projectname)
   check "Could not find its github repository. Check out its home page instead." $projectname || return 1
   echo "$(clrgreen 'Github project:') $projectname"

   pip show pygments &> /dev/null
   if [ $? -eq 0 ]; then
      local beautify=(pygmentize -l md -O style=monokai)
   else
      local beautify=(cat)
   fi

   local get=(curl -s -u username:$GITHUB_TOKEN)
   local changelogurl=$($get https://api.github.com/repos/$projectname/contents | sed -n $pat_changelogurl)
   check "Failed to find a changelog in the repository root. Looking for a readme instead." $changelogurl &&
      echo "$(clrgreen 'Found the changelog')" &&
      echo $changelogurl | xargs $get | $beautify && return 0

   local readmeurl=$($get https://api.github.com/repos/$projectname/readme | sed -n $pat_downloadurl)
   check "❓ $package doesn't have a readme❓" $readmeurl || return 1
   echo "$(clrgreen 'Found the readme')"
   echo $readmeurl | xargs $get | $beautify
}

##### DOCKER #####

dockerstop () {
    echo Killing every container which mentions $1
    docker ps --filter name=$1 | xargs -I{} docker stop {}
}

docker_noname_image_ids() { docker image ls | sed -n '/<none>/p' | tr -s ' ' | cut -d ' ' -f3 }
docker_delete_noname_images() { docker_noname_image_ids | xargs docker image rm }
docker_disk_usage() { sudo du -hd 1 /var/lib/docker/ | sort -h }


##### GENERAL TEXT PROCESSING #####
flushright() { sed -e :a -e 's/^.\{1,78\}$/ &/;ta' }
center() { sed  -e :a -e 's/^.\{1,77\}$/ &/;ta' -e 's/\( *\)\1/\1/' }

##### GITHUB #####
pr_messages() {
   pname=$(git info | sed -n '/\.url/s/\(^.*github\.com\/\)\(.*\)\($\|.git\)/\2/p')
    curl -s -u username:$GITHUB_TOKEN https://api.github.com/repos/$pname/pulls/$1/comments |
        jq -M '.[] | {user, body, diff_hunk}' |             # select fields
        sed -n 's/.*\(body\|login\|diff_hunk\)": //p' |     # trim keys
        tr -d "'" |                                         # trim single quotes
        sed 's/^"\|",\?$//g' |                              # trim double quotes and commas from start and end
        xargs -0 echo -e {} |                               # apply newlines
        fold -w 78 |                                        # wrap
        sed '/^[a-z-]\+$\|^@@/{x;p;x;}' |                   # blank lines before / after diff
        sed '/^@@/,/^$/s/.*/\\\\t&/' |                      # tab code
        sed 's/\\t\(+.*\)/\\\\t\\\\e[1;32m\1\\\\e[0m/' |    # added lines -> green
        sed 's/\\t\(-.*\)/\\\\t\\\\e[1;31m\1\\\\e[0m/' |    # removed lines -> red
        sed 's/^[a-z-]\+$/\\\\e[1;3;34m&\\\\e[0m/' |        # nickname -> blue
        xprint
}

##### JIRA #####
show() {
    echo Looking for issue $1
    jira view $1 | pygmentize -l md -O style=fruity
}

beautify() {
    sed "y/\`'/  /" |
    sed "s/[-+]\?\+-[^0-9a-zA-Z]//" |
    tr -s " " |
    sed '/| |/d' |
    cut -d "|" -f-8 |  # remove `Assigned` column
        sed '2s/Is.*/\\\\e[1;3;32m&\\\\e[0m/' |
        sed 's/[A-Z]\+-[0-9]\+/\\\\e[1;37m&\\\\e[0m/' |
        sed 's/Story/\\\\e[1;32m&\\\\e[0m/' |
        sed 's/Sub-task/\\\\e[1;34m&\\\\e[0m/' |
        sed 's/Bug/\\\\e[1;31m&\\\\e[0m/' |
        sed 's/Incident/\\\\e[1;33m&\\\\e[0m/' |
        sed 's/Epic/\\\\e[1;38;5;99m&\\\\e[0m/' |
        sed 's/High\ /\\\\e[1;31m&\\\\e[0m/' |
        sed 's/Highest/\\\\e[5;38;5;124m&\\\\e[0m/' |
        sed 's/Medium/\\\\e[1;38;5;208m&\\\\e[0m/' |
        sed 's/Low/\\\\e[1;33m&\\\\e[0m/' |
    xargs -I{} echo -e "  {}" | column -s "|" -t | sed '2i \\a' | sed '$a \\n'
}

# issues() {
    # local sortopts
    # echo $sorter
    # case "$1" in
    #     (-C) usecc=yess
    #         sortopts=;;
    # esac
    # if (( $+@[hello] ))
    # then echo HaveVarHellohello; fi
    # echo Running
# }
#
printissues() { printf "\n\n" && jira list --template table --query $1 | beautify }

issues() {
    printissues "\
        resolution = unresolved and assignee=currentuser() \
        ORDER BY status DESC, priority DESC, created DESC"
}

allissues() {
    printissues "\
        sprint in openSprints() and assignee=currentuser() \
        ORDER BY status DESC, priority DESC, created DESC"
}

sissues() {
    printissues "\
        sprint in openSprints() and \
        resolution=unresolved and assignee=currentuser() \
        ORDER BY status DESC, priority DESC, created DESC"
}

##### CONVERSION BETWEEN FORMATS #####
rst2md() {
    local filename=$1:t
    local naked=$filename:r
    local output=$naked.md
    echo Converting $filename to $output
    pandoc $filename \
        -s \
        --from rst \
        --to gfm \
        -o $output \
        --toc \
        --toc-depth 2
}

pandoc2pdf() {
    local filename=$1:t
    local from=$2
    local naked=$filename:r
    local output=$naked.pdf
    echo Converting $filename to $output
    pandoc $filename \
        -s \
        -f $from \
        -o $output \
        -V geometry:margin=1.4in \
        --toc \
        --toc-depth 2 \
        --pdf-engine=xelatex \
        --highlight-style=$HOME/.ref/sarastango.theme
}
rst2pdf() { pandoc2pdf $1 rst }
md2pdf() { pandoc2pdf $1 gfm }
