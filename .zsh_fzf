function preview_arg() {
    echo "'[[ \$(file --mime {}) =~ binary ]] &&
           echo file ||
           (bat --style=numbers
                --color=always {} || cat {})
           2> /dev/null | head -400'" | \
               tr '\n' ' ' | \
               tr -s ' '  # leave 1 space between lines
}
function preview_window_arg() {
    echo "'right:hidden:wrap'"
}
function mappings_arg() {
    echo "'f3:execute(bat --style=numbers {} || less -f {}),
           ctrl-]:toggle-preview,
           ctrl-\\:toggle-preview-wrap,
           ctrl-d:preview-page-down,
           ctrl-u:preview-page-up,
           ctrl-a:select-all+accept,
           ctrl-y:execute-silent
           (echo {+} | xclip | -sel clipboard)'" | \
               tr '\n' ' ' | \
               sed 's/\ \ //g'  # do not leave a single space
}

local misc="--no-mouse --height 60% -1 --reverse --multi --inline-info"

local FD_OPTIONS="--follow --hidden --exclude \*.html --exclude .git --exclude node_modules"

export FZF_COMPLETION_TRIGGER="8"
export FZF_DEFAULT_OPTS="$misc --preview=`preview_arg` --preview-window=`preview_window_arg` --bind=`mappings_arg`"
export FZF_DEFAULT_COMMAND="git ls-files --cached --others --exclude-standard | fd --type f --type l $FD_OPTIONS"
export FZF_CTRL_T_COMMAND="fd $FD_OPTIONS"
export FZF_ALT_C_COMMAND="fd --type d $FD_OPTIONS"

f() {
    sels=( "${(@f)$(fd "${fd_default[@]}" "${@:2}"| fzf)}" )
    test -n "$sels" && print -z -- "$1 ${sels[@]:q:q}"
}

unfunction preview_arg
unfunction preview_window_arg
unfunction mappings_arg
